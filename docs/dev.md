# Firmware Developers Guide

Modified: 2024-01

This document will provide the resources developers need to get started working on the firmware for this project.


## Navigation
1. [Toolchain Installation](#toolchain-installation)
2. [STM32 Headers](#stm32-headers)

> Note for Windows Installations - The binary files included as part of these software installations should be included as part of your system path. If the installer has the option, be sure to enable system path discovery.

## Toolchain Installation
The CGT is on version 10.3 at the time of writing. Note that these downloads are large and may take some time.
### MacOSX
Get the CMSIS `arm-none-eabi-gcc` toolchain for ARM Cortex microcontrollers:
```bash
brew install --cask gcc-arm-embedded
```
### Windows
Download version 10.3 from the windows install link [here](https://developer.arm.com/downloads/-/gnu-rm)

## OpenOCD Installation
This demo version 0.11.0 which at the time of writing is the latest `openocd` version
### MacOSX
Get `openocd` using `brew`:
```bash
brew install openocd
```
### Windows
Download xPack OpenOCD v0.11.0-5 (xpack-openocd-0.11.0-5-win32-x64.zip) from the github release link [here](https://github.com/xpack-dev-tools/openocd-xpack/releases)

## CMake Installation
This demo requires a minimum `cmake` version 3.24 to build.
### MacOSX
Install `cmake` using `brew`:
```bash
brew install cmake
```
### Windows
Download version `3.34` or higher from the windows install link [here](https://cmake.org/download/)

## VSCode Setup
In order to setup VSCode for development with STM32 microcontrollers, it is recommended you install the following extensions:
1. `ms-vscode.cpptools` - C/C++ intellisense support
2. `marus25.cortex-debug` - STM32 Debugger Support
3. `twxs.cmake` - Provides CMake language intellisense

Create a `.vscode` folder in the repository root and copy the files in the [vscode](/utils/vscode) directory into it. The files included provide the following capability:
1. `c_cpp_properties.json` -> configuration for C/C++ intellisense and static analysis tools.
2. `launch.json` -> plugin for vscode debugging interface powered by `cortex-debug`

Because the `c_cpp_properties.json` requires a compile commands file to be generated, you will need to **build the firmware** in order to realize these features. This is because intellisense is configured to look for a `compile_commands.json` file in the `build` directory to know how to find all the include headers and source files. When the firmware is built successfully a `compile_commands.json` file will be present and you will be able to use intellisense features.

## Compiling the Firmware
Clone this repository and navigate to the repository root:
```bash
git clone git@github.com:dronectl/raptor.git
cd raptor
```
Initialize the build system using `cmake`. For development we should set the `CMAKE_BUILD_TYPE` to `DEBUG`:

> Compile commands will be automatically generated by cmake which will be read by VSCode via the `c_cpp_properties.json` configuration.

```bash
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=DEBUG
...
```
Compile the firmware:
> Hint: speed up build times use -j`nproc` to enable multicore builds using all available cores.

```bash
make -j`nproc`
...
```
Once complete the binary should be built as `raptor.elf` in the `build` directory. You should also have a `compile_commands.json` file which will now enable intellisense features. If everything is done correctly there should be no red underline or default colored function names or variables indicating an unknown symbol. Below is an example of properly configured intellisense:
![isense-demo](img/isense-demo.png)

## Debugging

> You must build the project with `-DCMAKE_BUILD_TYPE=DEBUG` to enable debug symbols.

### VSCode
Once the project binary is built, we can launch the vscode debugger using the `F5` key. Under the hood VSCode references the `launch.json` configuration file to use OpenOCD to flash the firmware and open a GDB server. To setup this configuration be sure to follow the steps in the [VSCode Setup](#vscode-setup) Here is a sample view of the debugger view:



Below is a list of capabilities provided by the `cortex-debug` extension:
 - Cortex peripheral register read and set
 - Variable inspection and watchpoints
 - Live breakpoints
 - Task seperated call stacks
 - Task runtime statistics
 - MCU memory inspection


### STM32CubeIDE


## Flashing Firmware
The flash step is powered by OpenOCD. 
> OpenOCD will retrieve the binary from `build/raptor.elf` and program the MCU using [this](/utils/stm32h723.cfg) configuration spec.

Plugin the evaluation board to your PC over mini USB and flash the microcontroller using the `flash` directive:
```bash
make flash
```

## Issues
If there are any issues with this documentation please contact me using my github email or create a new issue.